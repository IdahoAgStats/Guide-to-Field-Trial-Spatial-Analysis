# rejected scripts

### Spatial error model (SEM)

This is also refered to as the "moving average model" and is quite similar to auto-regressive model. SAR models the spatial dependence of the variable of interest. SEM models the spatial dependence of the error terms. 

$$\mathbf {Y= X\beta + u} \\ \mathbf {u = \lambda W + \nu}$$

Where $\mathbf{u}$ incorporates both the normally-distributed iid error and spatially correlated error. Like in SAR, $\mathbf{W}$ is a matrix of spatial weights and $\lambda$ is a parameter describing auto-correlation of the error terms. 

### ARIMA 

The AR1 and MA1 models can be combine into one: 

$$ y = X\beta + \rho W_1y+u \\ u = \lambda W_2 + \nu $$
### AR1xAR1

The package **sommer** implements a version of the AR1xAR1 covariance structure. However, it does not estimate the parameter $\rho$. The user must specify the $\rho$ and that value is not optimized in the restricted maximum likelihood estimation. There may be another way to implement the AR1xAR1 spatial model using the package **TMB**. Both SAS and Asreml can implement a mixed model with this covariance structure.

### ???

The package **spaMM** implements additional correlation models such as Mat√©rn, Cauchy and more. 


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(sommer) 

Nin$colF <- as.factor(Nin$col)
Nin$rowF <- as.factor(Nin$row)

nin_ar1ar1 <- mmer(yield ~ gen,
                     random = ~ rep + 
                      vs(colF:rowF, Gu = kronecker(AR1(colF, rho=0.5), AR1(rowF, rho = 0.5), make.dimnames = TRUE)),
                   na.method.X = "include", na.method.Y = "exclude",
                   rcov = ~ units, data = Nin)

preds_ar1ar1 <- predict(nin_ar1ar1, classify = 'gen')$pvals 
```



### Spatial error model

```{r}
nin.sem <- errorsarlm(yield ~ gen + rep,
                       listw = nb2listw(xy.rook),
                       data = Nin, na.action = na.exclude)

mat.preds <- coef
```

### Combined spatial lag and error model (ARMA)

```{r}
nin.arma <- sacsarlm(yield ~ gen + rep,
                       listw = nb2listw(xy.rook),
                       data = Nin, na.action = na.exclude)


```

Obtaining predictions from the objects of `lagsarlm()`, `errorsarlm()`, and `sacsarlm()` is a challenging task not covered here. 

```{r eval=FALSE, include=FALSE}
# comparable with nlme
# from the package spAMM

nin.matern <- fitme(yield ~ gen + (1|rep) +
                      Matern(1|col.width + row.length),
                    fixed = list(rho = 1/range, nu = kappa),
                    data = Nin, method="ML")

preds = predict(nin.matern, re.form = ~gen,
                variance = list(fixefVar=TRUE))

matern.preds <- data.frame(gen = attributes(preds)$frame,
                           emmeans = preds,
                           var = attributes(preds)$fixefVar) %>%
  distinct() %>% mutate(SE = sqrt(var))

```


# doesn't work, treatments have to be numberic (what?)
```{r}
library(spANOVA)
model <- aovSar.rcbd(Nin$yield, Nin$gen, Nin$rep)
```

```{r eval=FALSE, include=FALSE}
library(rayshader)
options(cores = 3)
```

```{r eval=FALSE, include=FALSE}
# this function is so slow!!
layout.gg <- ggplot(Nin, aes(x = row.length, y = col.width)) +
  geom_tile(aes(fill = yield), col = "black") +
  scale_fill_gradient(low = "white", high = "blue") +
  coord_fixed() + 
  theme_void() 

plot_gg(layout.gg, multicore = T, width = 10, height = 5, scale = 300, 
        background = "white",shadowcolor = "#3a4f70") 

render_snapshot(clear = T)  # for rayshader, so so slow
```
  
  
## Spatial Autoregression

These models are not being used further because:
1. They are only set up for CRD and RCBD
2. the blocks AND genotypes must be coded as numeric vectors 
3. This uses OLS to solve the equations
4. In order to get out any means, many comparisons have to be made rather than just returning the means 
5. the shiny app seems to have some problems - it did not load the NIN data set properly (but that did load fine into R with read.csv())

(also called the Spatial lag model or SAR)
This requires the package **spANOVA** which is large and may take a few seconds to load. 
```{r, message=FALSE, warning=FALSE, include=FALSE}
library(spANOVA)
## get that model in here!!

library(agridat); data("stroup.nin")
nin_sar <- aovSar.rcbd(resp = as.vector(stroup.nin$yield), 
                                 treat = as.vector(stroup.nin$gen), 
                                 block = as.vector(stroup.nin$rep), 
                                 coord = cbind(stroup.nin$col, stroup.nin$row))
```
                    
