<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 5 Applying Spatial Covariates | Incorporating Spatial Analysis into Agricultural Field Experiments.</title>
  <meta name="description" content="This includes instructions for diagnosing spatial variation in agricultural field trials and incorporating spatial variation into analysis of the trial using freely available tools in R." />
  <meta name="generator" content="bookdown 0.12 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 5 Applying Spatial Covariates | Incorporating Spatial Analysis into Agricultural Field Experiments." />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This includes instructions for diagnosing spatial variation in agricultural field trials and incorporating spatial variation into analysis of the trial using freely available tools in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 5 Applying Spatial Covariates | Incorporating Spatial Analysis into Agricultural Field Experiments." />
  
  <meta name="twitter:description" content="This includes instructions for diagnosing spatial variation in agricultural field trials and incorporating spatial variation into analysis of the trial using freely available tools in R." />
  

<meta name="author" content="Julia Piaskowski" />


<meta name="date" content="2019-07-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch3.html">
<link rel="next" href="ch3-part3.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#tutorial-goals"><i class="fa fa-check"></i><b>1.1</b> Tutorial goals</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>1.2</b> Prerequisites</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#packages-we-will-use"><i class="fa fa-check"></i><b>1.3</b> Packages we will use</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i><b>1.4</b> Acknowledgements</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i><b>1.5</b> License</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#why-care-about-spatial-variation"><i class="fa fa-check"></i><b>2.1</b> Why care about spatial variation?</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#diagnosing-spatial-autocorrelation"><i class="fa fa-check"></i><b>2.2</b> Diagnosing spatial autocorrelation</a><ul>
<li class="chapter" data-level="2.2.1" data-path="intro.html"><a href="intro.html#morans-i"><i class="fa fa-check"></i><b>2.2.1</b> Moran’s I</a></li>
<li class="chapter" data-level="2.2.2" data-path="intro.html"><a href="intro.html#empirical-variogram-semivariance"><i class="fa fa-check"></i><b>2.2.2</b> Empirical variogram &amp; semivariance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html"><i class="fa fa-check"></i><b>3</b> Spatial Models {ch2-bg}</a><ul>
<li class="chapter" data-level="3.1" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#correlated-error-models"><i class="fa fa-check"></i><b>3.1</b> Correlated Error Models</a><ul>
<li class="chapter" data-level="3.1.1" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#distance-based-correlation-error-models"><i class="fa fa-check"></i><b>3.1.1</b> Distance-based Correlation Error Models</a></li>
<li class="chapter" data-level="3.1.2" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#correlated-error-models-for-gridded-data"><i class="fa fa-check"></i><b>3.1.2</b> Correlated Error Models for Gridded Data</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#nearest-neighbor-approaches"><i class="fa fa-check"></i><b>3.2</b> Nearest Neighbor Approaches</a><ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#spatial-durbin-approach"><i class="fa fa-check"></i><b>3.2.1</b> Spatial Durbin Approach</a></li>
<li class="chapter" data-level="3.2.2" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#spatial-autoregressive-sar"><i class="fa fa-check"></i><b>3.2.2</b> Spatial Autoregressive (SAR)</a></li>
<li class="chapter" data-level="3.2.3" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#spatial-error-model-sem"><i class="fa fa-check"></i><b>3.2.3</b> Spatial Error Model (SEM)</a></li>
<li class="chapter" data-level="3.2.4" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#arima"><i class="fa fa-check"></i><b>3.2.4</b> ARIMA</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#trend-analysis"><i class="fa fa-check"></i><b>3.3</b> Trend Analysis</a><ul>
<li class="chapter" data-level="3.3.1" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#row-column-and-combined-and-row-plus-column-trends."><i class="fa fa-check"></i><b>3.3.1</b> Row, column and combined and row plus column trends.</a></li>
<li class="chapter" data-level="3.3.2" data-path="spatial-models-ch2-bg.html"><a href="spatial-models-ch2-bg.html#splines"><i class="fa fa-check"></i><b>3.3.2</b> Splines</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch3.html"><a href="ch3.html"><i class="fa fa-check"></i><b>4</b> Example Analysis</a><ul>
<li class="chapter" data-level="4.1" data-path="ch3.html"><a href="ch3.html#load-data"><i class="fa fa-check"></i><b>4.1</b> Load Data</a><ul>
<li class="chapter" data-level="4.1.1" data-path="ch3.html"><a href="ch3.html#examine-data"><i class="fa fa-check"></i><b>4.1.1</b> Examine Data</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch3.html"><a href="ch3.html#test-for-spatial-correlation"><i class="fa fa-check"></i><b>4.2</b> Test for Spatial Correlation</a><ul>
<li class="chapter" data-level="4.2.1" data-path="ch3.html"><a href="ch3.html#morans-i-1"><i class="fa fa-check"></i><b>4.2.1</b> Moran’s I</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch3.html"><a href="ch3.html#note-on-gearys-c"><i class="fa fa-check"></i><b>4.2.2</b> Note on Geary’s C</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch3.html"><a href="ch3.html#empirical-variogram-fitting"><i class="fa fa-check"></i><b>4.3</b> Empirical Variogram Fitting</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch4.html"><a href="ch4.html"><i class="fa fa-check"></i><b>5</b> Applying Spatial Covariates</a><ul>
<li class="chapter" data-level="5.1" data-path="ch4.html"><a href="ch4.html#prep-work"><i class="fa fa-check"></i><b>5.1</b> Prep work</a></li>
<li class="chapter" data-level="5.2" data-path="ch4.html"><a href="ch4.html#correlated-errors-i-spatial-distance"><i class="fa fa-check"></i><b>5.2</b> Correlated Errors I: spatial distance</a><ul>
<li class="chapter" data-level="5.2.1" data-path="ch4.html"><a href="ch4.html#exponential"><i class="fa fa-check"></i><b>5.2.1</b> Exponential</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch4.html"><a href="ch4.html#spherical"><i class="fa fa-check"></i><b>5.2.2</b> Spherical</a></li>
<li class="chapter" data-level="5.2.3" data-path="ch4.html"><a href="ch4.html#power"><i class="fa fa-check"></i><b>5.2.3</b> Power</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ch4.html"><a href="ch4.html#nearest-neighbor-approaches-1"><i class="fa fa-check"></i><b>5.3</b> Nearest Neighbor Approaches</a><ul>
<li class="chapter" data-level="5.3.1" data-path="ch4.html"><a href="ch4.html#estimating-lagged-autocorrelation"><i class="fa fa-check"></i><b>5.3.1</b> estimating lagged autocorrelation</a></li>
<li class="chapter" data-level="5.3.2" data-path="ch4.html"><a href="ch4.html#durban"><i class="fa fa-check"></i><b>5.3.2</b> Durban</a></li>
<li class="chapter" data-level="5.3.3" data-path="ch4.html"><a href="ch4.html#spatial-lag-model"><i class="fa fa-check"></i><b>5.3.3</b> Spatial lag model</a></li>
<li class="chapter" data-level="5.3.4" data-path="ch4.html"><a href="ch4.html#spatial-error-model"><i class="fa fa-check"></i><b>5.3.4</b> Spatial error model</a></li>
<li class="chapter" data-level="5.3.5" data-path="ch4.html"><a href="ch4.html#combined-spatial-lag-and-error-model-arma"><i class="fa fa-check"></i><b>5.3.5</b> Combined spatial lag and error model (ARMA)</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="ch4.html"><a href="ch4.html#p-splines"><i class="fa fa-check"></i><b>5.4</b> p-Splines</a><ul>
<li class="chapter" data-level="5.4.1" data-path="ch4.html"><a href="ch4.html#ar1xar1-not-possible"><i class="fa fa-check"></i><b>5.4.1</b> AR1xAR1 (not possible!!)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch3-part3.html"><a href="ch3-part3.html"><i class="fa fa-check"></i><b>6</b> Comparing Spatial Models</a><ul>
<li class="chapter" data-level="6.1" data-path="ch3-part3.html"><a href="ch3-part3.html#example-one"><i class="fa fa-check"></i><b>6.1</b> Example one</a></li>
<li class="chapter" data-level="6.2" data-path="ch3-part3.html"><a href="ch3-part3.html#example-two"><i class="fa fa-check"></i><b>6.2</b> Example two</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Incorporating Spatial Analysis into Agricultural Field Experiments.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch4" class="section level1">
<h1><span class="header-section-number">Section 5</span> Applying Spatial Covariates</h1>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="kw">library</span>(agridat); <span class="kw">library</span>(dplyr); <span class="kw">library</span>(tidyr)</a>
<a class="sourceLine" id="cb57-2" data-line-number="2"><span class="kw">data</span>(<span class="st">&quot;stroup.nin&quot;</span>)</a>
<a class="sourceLine" id="cb57-3" data-line-number="3"></a>
<a class="sourceLine" id="cb57-4" data-line-number="4">Nin &lt;-<span class="st"> </span>stroup.nin <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">col.width =</span> col <span class="op">*</span><span class="st"> </span><span class="fl">1.2</span>, <span class="dt">row.length =</span> row <span class="op">*</span><span class="st"> </span><span class="fl">4.3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">case_when</span>(<span class="kw">is.na</span>(<span class="kw">as.character</span>(rep)) <span class="op">~</span><span class="st"> </span><span class="ot">NA_character_</span>, </a>
<a class="sourceLine" id="cb57-6" data-line-number="6">                          <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span><span class="kw">as.character</span>(gen))) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(col, row) </a>
<a class="sourceLine" id="cb57-7" data-line-number="7"></a>
<a class="sourceLine" id="cb57-8" data-line-number="8">Nin.na &lt;-<span class="st"> </span><span class="kw">filter</span>(Nin, <span class="op">!</span><span class="kw">is.na</span>(rep))</a>
<a class="sourceLine" id="cb57-9" data-line-number="9"></a>
<a class="sourceLine" id="cb57-10" data-line-number="10">Nin.spatial &lt;-<span class="st"> </span>Nin.na</a>
<a class="sourceLine" id="cb57-11" data-line-number="11"><span class="kw">coordinates</span>(Nin.spatial) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>col.width <span class="op">+</span><span class="st"> </span>row.length</a></code></pre></div>
<p>Once spatial autocorrelation has been identified in field trials, the next logical step is to employ a modelling technique that will reduce the impact of spatial varition on the final estiamtes from the analysis.</p>
<div id="prep-work" class="section level2">
<h2><span class="header-section-number">5.1</span> Prep work</h2>
<p>As a reminder, the first thing is to run a standard linear model. A common model specification for the randomised complete block design (RCBD) is to include cultivar as a fixed effect and block as a random effect.</p>
<p>Here is the R code for RCBD analsysis of the NIN data set loaded in Section 3 <a href="#ch:ch3"><strong>??</strong></a> that was found to have strong spatial correlation:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="kw">library</span>(nlme)</a>
<a class="sourceLine" id="cb58-2" data-line-number="2"></a>
<a class="sourceLine" id="cb58-3" data-line-number="3">nin.lme &lt;-<span class="st"> </span><span class="kw">lme</span>(yield <span class="op">~</span><span class="st"> </span>gen, <span class="dt">random =</span> <span class="op">~</span><span class="dv">1</span><span class="op">|</span>rep,</a>
<a class="sourceLine" id="cb58-4" data-line-number="4">              <span class="dt">data =</span> Nin,</a>
<a class="sourceLine" id="cb58-5" data-line-number="5">              <span class="dt">na.action =</span> na.exclude)</a>
<a class="sourceLine" id="cb58-6" data-line-number="6"></a>
<a class="sourceLine" id="cb58-7" data-line-number="7"><span class="kw">anova</span>(nin.lme)</a></code></pre></div>
<pre><code>##             numDF denDF   F-value p-value
## (Intercept)     1   165 242.05402  &lt;.0001
## gen            55   165   0.87549  0.7119</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw">library</span>(spdep)</a>
<a class="sourceLine" id="cb60-2" data-line-number="2">xy.rook &lt;-<span class="st"> </span><span class="kw">cell2nb</span>(<span class="dt">nrow =</span> <span class="kw">max</span>(Nin<span class="op">$</span>row), <span class="dt">ncol =</span> <span class="kw">max</span>(Nin<span class="op">$</span>col), <span class="dt">type=</span><span class="st">&quot;rook&quot;</span>) </a>
<a class="sourceLine" id="cb60-3" data-line-number="3"><span class="kw">moran.test</span>(<span class="kw">residuals</span>(nin.lme), <span class="kw">nb2listw</span>(xy.rook), <span class="dt">na.action =</span> na.exclude)</a></code></pre></div>
<pre><code>## 
##  Moran I test under randomisation
## 
## data:  residuals(nin.lme)  
## weights: nb2listw(xy.rook) 
## omitted: 1, 12, 23, 34, 45, 56, 59, 67, 78, 89, 100, 108, 111, 122, 133, 144, 155, 204   
## 
## Moran I statistic standard deviate = 8.1602, p-value &lt; 2.2e-16
## alternative hypothesis: greater
## sample estimates:
## Moran I statistic       Expectation          Variance 
##       0.402504491      -0.004484305       0.002487522</code></pre>
<p>The variables “gen” refers to the cultivar or breeding line being trialled, and “rep” is the block, and the dependent variable, “yield” is grain yield. Basic exploratory analysis was conducted in Section 3 <a href="#ch:ch3"><strong>??</strong></a>.</p>
</div>
<div id="correlated-errors-i-spatial-distance" class="section level2">
<h2><span class="header-section-number">5.2</span> Correlated Errors I: spatial distance</h2>
<p><strong>Gaussian Example</strong></p>
<p>In order to fit models using correlated error model, we will need to first obtain preliminary estimates of the nugget, sill and range: from fitting an empirical variogram.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb62-2" data-line-number="2">max_dist &lt;-<span class="st"> </span><span class="fl">0.6</span><span class="op">*</span><span class="kw">max</span>(<span class="kw">dist</span>(<span class="kw">coordinates</span>(Nin.spatial)))</a>
<a class="sourceLine" id="cb62-3" data-line-number="3">resid.var1 &lt;-<span class="st"> </span><span class="kw">variogram</span>(yield <span class="op">~</span><span class="st"> </span>rep <span class="op">+</span><span class="st"> </span>gen, </a>
<a class="sourceLine" id="cb62-4" data-line-number="4">                        <span class="dt">cutoff =</span> max_dist,</a>
<a class="sourceLine" id="cb62-5" data-line-number="5">                        <span class="dt">width =</span> max_dist<span class="op">/</span><span class="dv">29</span>, </a>
<a class="sourceLine" id="cb62-6" data-line-number="6">                        <span class="dt">data =</span> Nin.spatial)</a>
<a class="sourceLine" id="cb62-7" data-line-number="7">nugget_start &lt;-<span class="st"> </span><span class="kw">min</span>(resid.var1<span class="op">$</span>gamma)</a></code></pre></div>
<pre><code>
Nin.vgm1 &lt;- vgm(model = &quot;Exp&quot;, nugget = nugget_start) 
Nin.vgm2 &lt;- vgm(model = &quot;Sph&quot;, nugget = nugget_start) 

Nin.vgm4 &lt;- vgm(model = &quot;Mat&quot;, nugget = nugget_start)

Nin.variofit1 &lt;- fit.variogram(resid.var1, Nin.vgm1)
Nin.variofit2 &lt;- fit.variogram(resid.var1, Nin.vgm2)

Nin.variofit4 &lt;- fit.variogram(resid.var1, Nin.vgm4)</code></pre>
<p>In the previous section, an isotropic Gaussian function was identified as the best mocel for describing the decay of eror correlation over distance.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">Nin.vgm &lt;-<span class="st"> </span><span class="kw">vgm</span>(<span class="dt">model =</span> <span class="st">&quot;Gau&quot;</span>, <span class="dt">nugget =</span> nugget_start) </a>
<a class="sourceLine" id="cb64-2" data-line-number="2">Nin.variofit &lt;-<span class="st"> </span><span class="kw">fit.variogram</span>(resid.var1, Nin.vgm)</a>
<a class="sourceLine" id="cb64-3" data-line-number="3"></a>
<a class="sourceLine" id="cb64-4" data-line-number="4">nugget &lt;-<span class="st"> </span>Nin.variofit<span class="op">$</span>psill[<span class="dv">1</span>] </a>
<a class="sourceLine" id="cb64-5" data-line-number="5">range &lt;-<span class="st"> </span>Nin.variofit<span class="op">$</span>range[<span class="dv">2</span>] </a>
<a class="sourceLine" id="cb64-6" data-line-number="6">sill &lt;-<span class="st"> </span><span class="kw">sum</span>(Nin.variofit<span class="op">$</span>psill) </a>
<a class="sourceLine" id="cb64-7" data-line-number="7">nugget.effect &lt;-<span class="st">  </span>nugget<span class="op">/</span>sill</a></code></pre></div>
<p>Next, create a correlated error structure (from the <strong>nlme</strong> package).</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1">cor.gaus &lt;-<span class="st"> </span><span class="kw">corSpatial</span>(<span class="dt">value =</span> <span class="kw">c</span>(range, nugget.effect), </a>
<a class="sourceLine" id="cb65-2" data-line-number="2">                  <span class="dt">form =</span> <span class="op">~</span><span class="st"> </span>row.length <span class="op">+</span><span class="st"> </span>col.width, </a>
<a class="sourceLine" id="cb65-3" data-line-number="3">                  <span class="dt">nugget =</span> T, <span class="dt">fixed =</span> F,</a>
<a class="sourceLine" id="cb65-4" data-line-number="4">                  <span class="dt">type =</span> <span class="st">&quot;gaussian&quot;</span>, </a>
<a class="sourceLine" id="cb65-5" data-line-number="5">                  <span class="dt">metric =</span> <span class="st">&quot;euclidean&quot;</span>)</a></code></pre></div>
<p>Last, update the linear mixed model with the correlated error strucutre and inspect the results:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1">nin.gaus &lt;-<span class="st"> </span><span class="kw">update</span>(nin.lme, <span class="dt">corr =</span> cor.gaus)</a>
<a class="sourceLine" id="cb66-2" data-line-number="2"><span class="kw">anova</span>(nin.gaus)</a></code></pre></div>
<pre><code>##             numDF denDF   F-value p-value
## (Intercept)     1   165 157.36740  &lt;.0001
## gen            55   165   1.78151  0.0028</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="co">#moran.test(residuals(nin.gaus), nb2listw(xy.rook), na.action = na.exclude)</span></a></code></pre></div>
<p>Other models can be implemented quite similarily:</p>
<div id="exponential" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Exponential</h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1"><span class="kw">rm</span>(Nin.vgm, Nin.variofit, nugget, sill, range, nugget.effect)</a>
<a class="sourceLine" id="cb69-2" data-line-number="2"></a>
<a class="sourceLine" id="cb69-3" data-line-number="3">Nin.vgm &lt;-<span class="st"> </span><span class="kw">vgm</span>(<span class="dt">model =</span> <span class="st">&quot;Exp&quot;</span>, <span class="dt">nugget =</span> nugget_start) </a>
<a class="sourceLine" id="cb69-4" data-line-number="4">Nin.variofit &lt;-<span class="st"> </span><span class="kw">fit.variogram</span>(resid.var1, Nin.vgm)</a>
<a class="sourceLine" id="cb69-5" data-line-number="5"></a>
<a class="sourceLine" id="cb69-6" data-line-number="6">nugget &lt;-<span class="st"> </span>Nin.variofit<span class="op">$</span>psill[<span class="dv">1</span>] </a>
<a class="sourceLine" id="cb69-7" data-line-number="7">range &lt;-<span class="st"> </span>Nin.variofit<span class="op">$</span>range[<span class="dv">2</span>] </a>
<a class="sourceLine" id="cb69-8" data-line-number="8">sill &lt;-<span class="st"> </span><span class="kw">sum</span>(Nin.variofit<span class="op">$</span>psill) </a>
<a class="sourceLine" id="cb69-9" data-line-number="9">nugget.effect &lt;-<span class="st">  </span>nugget<span class="op">/</span>sill</a>
<a class="sourceLine" id="cb69-10" data-line-number="10"></a>
<a class="sourceLine" id="cb69-11" data-line-number="11">cor.exp &lt;-<span class="st"> </span><span class="kw">corSpatial</span>(<span class="dt">value =</span> <span class="kw">c</span>(range, nugget.effect), </a>
<a class="sourceLine" id="cb69-12" data-line-number="12">                  <span class="dt">form =</span> <span class="op">~</span><span class="st"> </span>row.length <span class="op">+</span><span class="st"> </span>col.width, </a>
<a class="sourceLine" id="cb69-13" data-line-number="13">                  <span class="dt">nugget =</span> T, <span class="dt">fixed =</span> F,</a>
<a class="sourceLine" id="cb69-14" data-line-number="14">                  <span class="dt">type =</span> <span class="st">&quot;exponential&quot;</span>, </a>
<a class="sourceLine" id="cb69-15" data-line-number="15">                  <span class="dt">metric =</span> <span class="st">&quot;euclidean&quot;</span>)</a>
<a class="sourceLine" id="cb69-16" data-line-number="16"></a>
<a class="sourceLine" id="cb69-17" data-line-number="17">nin.exp &lt;-<span class="st"> </span><span class="kw">update</span>(nin.lme, <span class="dt">corr =</span> cor.exp)</a>
<a class="sourceLine" id="cb69-18" data-line-number="18"><span class="kw">anova</span>(nin.exp)</a></code></pre></div>
<pre><code>##             numDF denDF  F-value p-value
## (Intercept)     1   165 62.35102  &lt;.0001
## gen            55   165  1.83489  0.0018</code></pre>
</div>
<div id="spherical" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Spherical</h3>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1"><span class="kw">rm</span>(Nin.vgm, Nin.variofit, nugget, sill, range, nugget.effect)</a>
<a class="sourceLine" id="cb71-2" data-line-number="2"></a>
<a class="sourceLine" id="cb71-3" data-line-number="3">Nin.vgm &lt;-<span class="st"> </span><span class="kw">vgm</span>(<span class="dt">model =</span> <span class="st">&quot;Sph&quot;</span>, <span class="dt">nugget =</span> nugget_start) </a>
<a class="sourceLine" id="cb71-4" data-line-number="4">Nin.variofit &lt;-<span class="st"> </span><span class="kw">fit.variogram</span>(resid.var1, Nin.vgm)</a>
<a class="sourceLine" id="cb71-5" data-line-number="5"></a>
<a class="sourceLine" id="cb71-6" data-line-number="6">nugget &lt;-<span class="st"> </span>Nin.variofit<span class="op">$</span>psill[<span class="dv">1</span>] </a>
<a class="sourceLine" id="cb71-7" data-line-number="7">range &lt;-<span class="st"> </span>Nin.variofit<span class="op">$</span>range[<span class="dv">2</span>] </a>
<a class="sourceLine" id="cb71-8" data-line-number="8">sill &lt;-<span class="st"> </span><span class="kw">sum</span>(Nin.variofit<span class="op">$</span>psill) </a>
<a class="sourceLine" id="cb71-9" data-line-number="9">nugget.effect &lt;-<span class="st">  </span>nugget<span class="op">/</span>sill</a>
<a class="sourceLine" id="cb71-10" data-line-number="10"></a>
<a class="sourceLine" id="cb71-11" data-line-number="11">cor.sph &lt;-<span class="st"> </span><span class="kw">corSpatial</span>(<span class="dt">value =</span> <span class="kw">c</span>(range, nugget.effect), </a>
<a class="sourceLine" id="cb71-12" data-line-number="12">                  <span class="dt">form =</span> <span class="op">~</span><span class="st"> </span>row.length <span class="op">+</span><span class="st"> </span>col.width, </a>
<a class="sourceLine" id="cb71-13" data-line-number="13">                  <span class="dt">nugget =</span> T, <span class="dt">fixed =</span> F,</a>
<a class="sourceLine" id="cb71-14" data-line-number="14">                  <span class="dt">type =</span> <span class="st">&quot;spherical&quot;</span>, </a>
<a class="sourceLine" id="cb71-15" data-line-number="15">                  <span class="dt">metric =</span> <span class="st">&quot;euclidean&quot;</span>)</a>
<a class="sourceLine" id="cb71-16" data-line-number="16"></a>
<a class="sourceLine" id="cb71-17" data-line-number="17">nin.sph &lt;-<span class="st"> </span><span class="kw">update</span>(nin.lme, <span class="dt">corr =</span> cor.sph)</a>
<a class="sourceLine" id="cb71-18" data-line-number="18"><span class="kw">anova</span>(nin.sph)</a></code></pre></div>
<pre><code>##             numDF denDF   F-value p-value
## (Intercept)     1   165 121.43563  &lt;.0001
## gen            55   165   1.83709  0.0018</code></pre>
</div>
<div id="power" class="section level3">
<h3><span class="header-section-number">5.2.3</span> Power</h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="kw">rm</span>(Nin.vgm, Nin.variofit, nugget, sill, range, nugget.effect)</a>
<a class="sourceLine" id="cb73-2" data-line-number="2"></a>
<a class="sourceLine" id="cb73-3" data-line-number="3">cor.pow &lt;-<span class="st"> </span><span class="kw">corSpatial</span>(<span class="dt">form =</span> <span class="op">~</span><span class="st"> </span>row.length <span class="op">+</span><span class="st"> </span>col.width, </a>
<a class="sourceLine" id="cb73-4" data-line-number="4">                  <span class="dt">nugget =</span> T, <span class="dt">fixed =</span> F,</a>
<a class="sourceLine" id="cb73-5" data-line-number="5">                  <span class="dt">type =</span> <span class="st">&quot;ratio&quot;</span>, </a>
<a class="sourceLine" id="cb73-6" data-line-number="6">                  <span class="dt">metric =</span> <span class="st">&quot;euclidean&quot;</span>)</a>
<a class="sourceLine" id="cb73-7" data-line-number="7"></a>
<a class="sourceLine" id="cb73-8" data-line-number="8">nin.pow &lt;-<span class="st"> </span><span class="kw">update</span>(nin.lme, <span class="dt">corr =</span> cor.pow)</a>
<a class="sourceLine" id="cb73-9" data-line-number="9"><span class="kw">anova</span>(nin.pow)</a></code></pre></div>
<pre><code>##             numDF denDF  F-value p-value
## (Intercept)     1   165 78.54890  &lt;.0001
## gen            55   165  1.78787  0.0027</code></pre>
<p>In the **nlme* package, there is also an option for a linear model in the <code>corSpatial()</code> function. However, it is recommended that a linear trend be fitted to the data instead.</p>
<p>The package **spaMM* implements additional correlation models such as Matérn, Cauchy and more.</p>
</div>
</div>
<div id="nearest-neighbor-approaches-1" class="section level2">
<h2><span class="header-section-number">5.3</span> Nearest Neighbor Approaches</h2>
<div id="estimating-lagged-autocorrelation" class="section level3">
<h3><span class="header-section-number">5.3.1</span> estimating lagged autocorrelation</h3>
<p>Prior to running any nearest neighbor appraoches, it is helpful to understand the lagged spatial autocorrelation.</p>
</div>
<div id="durban" class="section level3">
<h3><span class="header-section-number">5.3.2</span> Durban</h3>
<p>??</p>
</div>
<div id="spatial-lag-model" class="section level3">
<h3><span class="header-section-number">5.3.3</span> Spatial lag model</h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="kw">library</span>(spatialreg)</a>
<a class="sourceLine" id="cb75-2" data-line-number="2"></a>
<a class="sourceLine" id="cb75-3" data-line-number="3">nin.lag &lt;-<span class="st"> </span><span class="kw">lagsarlm</span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="op">+</span><span class="st"> </span>rep,</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">                       <span class="dt">listw =</span> <span class="kw">nb2listw</span>(xy.rook),</a>
<a class="sourceLine" id="cb75-5" data-line-number="5">                       <span class="dt">data =</span> Nin, <span class="dt">na.action =</span> na.exclude)</a>
<a class="sourceLine" id="cb75-6" data-line-number="6"></a>
<a class="sourceLine" id="cb75-7" data-line-number="7"><span class="kw">moran.mc</span>(<span class="kw">residuals</span>(nin.lag), <span class="kw">nb2listw</span>(xy.rook), <span class="dv">999</span>, <span class="dt">na.action =</span> na.exclude)</a></code></pre></div>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  residuals(nin.lag) 
## weights: nb2listw(xy.rook) 
## omitted: 1, 12, 23, 34, 45, 56, 59, 67, 78, 89, 100, 108, 111, 122, 133, 144, 155, 204 
## number of simulations + 1: 1000 
## 
## statistic = -0.080738, observed rank = 67, p-value = 0.933
## alternative hypothesis: greater</code></pre>
</div>
<div id="spatial-error-model" class="section level3">
<h3><span class="header-section-number">5.3.4</span> Spatial error model</h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">nin.sem &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="op">+</span><span class="st"> </span>rep,</a>
<a class="sourceLine" id="cb77-2" data-line-number="2">                       <span class="dt">listw =</span> <span class="kw">nb2listw</span>(xy.rook),</a>
<a class="sourceLine" id="cb77-3" data-line-number="3">                       <span class="dt">data =</span> Nin, <span class="dt">na.action =</span> na.exclude)</a>
<a class="sourceLine" id="cb77-4" data-line-number="4"></a>
<a class="sourceLine" id="cb77-5" data-line-number="5"><span class="kw">moran.mc</span>(<span class="kw">residuals</span>(nin.sem), <span class="kw">nb2listw</span>(xy.rook), <span class="dv">999</span>, <span class="dt">na.action =</span> na.exclude)</a></code></pre></div>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  residuals(nin.sem) 
## weights: nb2listw(xy.rook) 
## omitted: 1, 12, 23, 34, 45, 56, 59, 67, 78, 89, 100, 108, 111, 122, 133, 144, 155, 204 
## number of simulations + 1: 1000 
## 
## statistic = -0.1144, observed rank = 11, p-value = 0.989
## alternative hypothesis: greater</code></pre>
</div>
<div id="combined-spatial-lag-and-error-model-arma" class="section level3">
<h3><span class="header-section-number">5.3.5</span> Combined spatial lag and error model (ARMA)</h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">nin.arma &lt;-<span class="st"> </span><span class="kw">sacsarlm</span>(yield <span class="op">~</span><span class="st"> </span>gen <span class="op">+</span><span class="st"> </span>rep,</a>
<a class="sourceLine" id="cb79-2" data-line-number="2">                       <span class="dt">listw =</span> <span class="kw">nb2listw</span>(xy.rook),</a>
<a class="sourceLine" id="cb79-3" data-line-number="3">                       <span class="dt">data =</span> Nin, <span class="dt">na.action =</span> na.exclude)</a>
<a class="sourceLine" id="cb79-4" data-line-number="4"></a>
<a class="sourceLine" id="cb79-5" data-line-number="5"><span class="kw">moran.mc</span>(<span class="kw">residuals</span>(nin.arma), <span class="kw">nb2listw</span>(xy.rook), <span class="dv">999</span>, <span class="dt">na.action =</span> na.exclude)</a></code></pre></div>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  residuals(nin.arma) 
## weights: nb2listw(xy.rook) 
## omitted: 1, 12, 23, 34, 45, 56, 59, 67, 78, 89, 100, 108, 111, 122, 133, 144, 155, 204 
## number of simulations + 1: 1000 
## 
## statistic = -0.036476, observed rank = 256, p-value = 0.744
## alternative hypothesis: greater</code></pre>
</div>
</div>
<div id="p-splines" class="section level2">
<h2><span class="header-section-number">5.4</span> p-Splines</h2>
<div id="ar1xar1-not-possible" class="section level3">
<h3><span class="header-section-number">5.4.1</span> AR1xAR1 (not possible!!)</h3>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch3.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch3-part3.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["Field-Trial-Spatial-Analysis-Guide.pdf", "Field-Trial-Spatial-Analysis-Guide.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
